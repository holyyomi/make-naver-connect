name: ğŸ¬ Holy Moment ì¹¸ ê´‘ê³ ì œê¸‰ Video Editor

on:
  repository_dispatch:
    types: [video_edit]

jobs:
  edit-video:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ”§ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup FFmpeg & Dependencies
      run: |
        sudo apt update
        sudo apt install -y ffmpeg fonts-noto-cjk fonts-noto-cjk-extra
        ffmpeg -version
        echo "í•œê¸€ í°íŠ¸ ì„¤ì¹˜ ì™„ë£Œ:"
        fc-list | grep -i noto | head -5
        
    - name: â¬‡ï¸ Download Video Files with Fallback
      run: |
        echo "ğŸ¬ veo3 ì˜ìƒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘..."
        
        # ê° ì˜ìƒ íŒŒì¼ì„ wgetê³¼ curlë¡œ ì´ì¤‘ ì•ˆì „ì¥ì¹˜ ë‹¤ìš´ë¡œë“œ
        for i in {0..3}; do
          clip_num=$((i+1))
          video_url="${{ toJson(github.event.client_payload.videos) }}"
          video_url=$(echo "$video_url" | jq -r ".[$i]")
          
          echo "í´ë¦½ ${clip_num} ë‹¤ìš´ë¡œë“œ: $video_url"
          
          if wget -O "clip${clip_num}.mp4" "$video_url" 2>/dev/null; then
            echo "âœ… wgetìœ¼ë¡œ í´ë¦½ ${clip_num} ë‹¤ìš´ë¡œë“œ ì„±ê³µ"
          elif curl -L -o "clip${clip_num}.mp4" "$video_url" 2>/dev/null; then
            echo "âœ… curlë¡œ í´ë¦½ ${clip_num} ë‹¤ìš´ë¡œë“œ ì„±ê³µ"
          else
            echo "âŒ í´ë¦½ ${clip_num} ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi
        done
        
        echo "ğŸ“Š ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ í™•ì¸:"
        ls -la *.mp4
        
    - name: ğŸ¬ Execute Holy Moment FFmpeg Master Script
      run: |
        #!/bin/bash
        
        # ğŸ† Holy Moment ì¹¸ ê´‘ê³ ì œ ê·¸ë‘í”„ë¦¬ê¸‰ ë§ˆìŠ¤í„° í¸ì§‘ ìŠ¤í¬ë¦½íŠ¸ (GitHub Actions ìµœì í™”)
        
        set -e  # ì˜¤ë¥˜ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
        
        PRODUCT="${{ github.event.client_payload.product }}"
        DATE=$(date +%Y%m%d_%H%M%S)
        OUTPUT="HolyMoment_${PRODUCT}_${DATE}_CANNES_MASTERPIECE"
        
        echo 'ğŸ¬ ì¹¸ ê´‘ê³ ì œ ê·¸ë‘í”„ë¦¬ê¸‰ í¸ì§‘ ì‹œì‘'
        echo 'ğŸ“… ë‚ ì§œ: '$(date)
        echo 'ğŸ¯ ì œí’ˆ: '$PRODUCT
        echo 'ğŸ“± ê°€ë¡œì˜ìƒ â†’ ì„¸ë¡œì˜ìƒ ëª¨ë°”ì¼ ìµœì í™” ì‹œì‘'
        echo 'âš¡ GitHub Actions ë¬´ë£Œ í™˜ê²½ ìµœì í™” ëª¨ë“œ'
        
        # ===== 1ë‹¨ê³„: ê³ ê¸‰ íŒŒì¼ ê²€ì¦ ë° ë¶„ì„ =====
        echo 'ğŸ” Step 1: íŒŒì¼ ê²€ì¦ ë° ë©”íƒ€ë°ì´í„° ë¶„ì„'
        
        for i in {1..4}; do
          if [ ! -f "clip${i}.mp4" ]; then
            echo "âŒ í´ë¦½ ${i} íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          # ë¹„ë””ì˜¤ í’ˆì§ˆ ê²€ì¦
          WIDTH=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width -of csv=p=0 "clip${i}.mp4")
          HEIGHT=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=height -of csv=p=0 "clip${i}.mp4")
          DURATION=$(ffprobe -v quiet -select_streams v:0 -show_entries format=duration -of csv=p=0 "clip${i}.mp4")
          
          echo "ğŸ“Š í´ë¦½ ${i}: ${WIDTH}x${HEIGHT} (ê°€ë¡œì˜ìƒ), ê¸¸ì´: ${DURATION}ì´ˆ"
        done
        
        echo 'âœ… íŒŒì¼ ê²€ì¦ ì™„ë£Œ'
        
        # ===== 2ë‹¨ê³„: ê°€ë¡œâ†’ì„¸ë¡œ ì‹œë„¤ë§ˆí‹± ë³€í™˜ ë° ìƒ‰ë³´ì • (ì„±ëŠ¥ ìµœì í™”) =====
        echo 'ğŸ¨ Step 2: ê°€ë¡œâ†’ì„¸ë¡œ ì‹œë„¤ë§ˆí‹± ë³€í™˜ ë° í”„ë¦¬ë¯¸ì—„ ìƒ‰ë³´ì •'
        echo 'ğŸ’¡ veo3 ê°€ë¡œì˜ìƒì„ ëª¨ë°”ì¼ ìµœì í™” ì„¸ë¡œì˜ìƒ(9:16)ìœ¼ë¡œ ì™„ë²½ ë³€í™˜'
        
        for i in {1..4}; do
          echo "ğŸ”§ í´ë¦½ ${i} ê°€ë¡œâ†’ì„¸ë¡œ ë³€í™˜ ì²˜ë¦¬ ì¤‘..."
          
          # ê°€ë¡œì˜ìƒì„ ì„¸ë¡œì˜ìƒìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê³ ê¸‰ í•„í„° ì²´ì¸ (GitHub Actions ìµœì í™”)
          VIDEO_FILTERS=""
          
          # 1ë‹¨ê³„: ìŠ¤ë§ˆíŠ¸ í¬ë¡­ (ê°€ë¡œì˜ìƒì˜ ì¤‘ì•™ ë¶€ë¶„ì„ 9:16ìœ¼ë¡œ ì¶”ì¶œ)
          VIDEO_FILTERS+="scale=1920:-1:force_original_aspect_ratio=increase,"
          VIDEO_FILTERS+="crop=1080:1920:(iw-1080)/2:(ih-1920)/2,"
          
          # 2ë‹¨ê³„: í™”ì§ˆ í–¥ìƒ í•„í„° (í¬ë¡­ ë³´ìƒ)
          VIDEO_FILTERS+="unsharp=5:5:1.3:5:5:1.1,"
          VIDEO_FILTERS+="eq=contrast=1.10:brightness=0.05:saturation=1.08:gamma=0.96,"
          VIDEO_FILTERS+="nlmeans=s=1.5:p=5:r=10,"  # ì„±ëŠ¥ ìµœì í™”
          
          # 3ë‹¨ê³„: ì‹œë„¤ë§ˆí‹± ë£© ì ìš© (ëª¨ë°”ì¼ ìµœì í™”)
          VIDEO_FILTERS+="curves=m='0/0 0.22/0.20 0.5/0.58 0.78/0.80 1/1',"
          VIDEO_FILTERS+="colorbalance=rs=0.03:gs=-0.01:bs=-0.04:rm=0.02:gm=0.00:bm=-0.03,"
          
          # 4ë‹¨ê³„: ëª¨ë°”ì¼ í™”ë©´ ìµœì í™”
          VIDEO_FILTERS+="vibrance=intensity=0.12"
          
          # GitHub Actions í™˜ê²½ ìµœì í™”: fast preset, ì ì ˆí•œ CRF
          ffmpeg -i "clip${i}.mp4" \
            -vf "${VIDEO_FILTERS}" \
            -c:v libx264 -preset fast -crf=20 -profile:v high \
            -pix_fmt yuv420p -movflags +faststart \
            -c:a aac -b:a 192k -ar 48000 -ac 2 \
            -t 8.0 -avoid_negative_ts make_zero \
            -y "converted_${i}.mp4"
          
          echo "âœ… í´ë¦½ ${i} ê°€ë¡œâ†’ì„¸ë¡œ ë³€í™˜ ì™„ë£Œ"
        done
        
        # ===== 3ë‹¨ê³„: í”„ë¦¬ë¯¸ì—„ í•œê¸€ ìë§‰ ì‹œìŠ¤í…œ (ì„¸ë¡œì˜ìƒ ìµœì í™”) =====
        echo 'ğŸ“ Step 3: í”„ë¦¬ë¯¸ì—„ í•œê¸€ ìë§‰ ìƒì„± (ì„¸ë¡œì˜ìƒ ìµœì í™”)'
        
        # ìë§‰ í…ìŠ¤íŠ¸
        SUBTITLES=(
          "ì´ë ‡ê²Œ í˜ë“¤ ì¤„ ëª°ëì–´..."
          "${PRODUCT}ë¥¼ ë§Œë‚œ ìˆœê°„"
          "ì™„ì „íˆ ë‹¬ë¼ì§„ ë‚´ ì¼ìƒ"
          "ì •ë§ ê°ì‚¬í•œ Holy Moment"
        )
        
        # ê¸°ë³¸ ìë§‰ ìŠ¤íƒ€ì¼ ì„¤ì • (GitHub Actions í™˜ê²½ ìµœì í™”)
        FONT_SIZE=68
        FONT_COLOR='#FFFFFF'
        BOX_COLOR='#000000@0.80'
        FONT_FILE='/usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc'
        SHADOW='5:5:7:#000000@0.88'
        BORDER=16
        
        # í•œê¸€ í°íŠ¸ íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° ëŒ€ì²´
        if [ ! -f "$FONT_FILE" ]; then
          FONT_FILE='/usr/share/fonts/truetype/noto/NotoSansCJK-Bold.ttc'
          if [ ! -f "$FONT_FILE" ]; then
            echo "âš ï¸ í•œê¸€ í°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í°íŠ¸ ì‚¬ìš©."
            FONT_FILE=''
          fi
        fi
        
        # ê° í´ë¦½ì— í”„ë¦¬ë¯¸ì—„ ìë§‰ ì ìš©
        for i in {1..4}; do
          SUB_TEXT="${SUBTITLES[$((i-1))]}"
          
          echo "ğŸ“ í´ë¦½ ${i}ì— ìë§‰ ì ìš©: ${SUB_TEXT}"
          
          if [ -n "$FONT_FILE" ]; then
            # í•œê¸€ í°íŠ¸ ì‚¬ìš©
            ffmpeg -i "converted_${i}.mp4" \
              -vf "drawtext=text='${SUB_TEXT}':fontfile='${FONT_FILE}':fontsize=${FONT_SIZE}:fontcolor='${FONT_COLOR}':x=(w-text_w)/2:y=h-th-200:box=1:boxcolor='${BOX_COLOR}':boxborderw=${BORDER}:shadowcolor='${SHADOW}':shadowx=5:shadowy=5:enable='between(t,1.5,6.5)'" \
              -c:v libx264 -preset fast -crf=20 -pix_fmt yuv420p \
              -c:a copy -movflags +faststart \
              -y "subtitled_${i}.mp4"
          else
            # ê¸°ë³¸ í°íŠ¸ ì‚¬ìš©
            ffmpeg -i "converted_${i}.mp4" \
              -vf "drawtext=text='${SUB_TEXT}':fontsize=${FONT_SIZE}:fontcolor='${FONT_COLOR}':x=(w-text_w)/2:y=h-th-200:box=1:boxcolor='${BOX_COLOR}':boxborderw=${BORDER}:shadowcolor='${SHADOW}':shadowx=5:shadowy=5:enable='between(t,1.5,6.5)'" \
              -c:v libx264 -preset fast -crf=20 -pix_fmt yuv420p \
              -c:a copy -movflags +faststart \
              -y "subtitled_${i}.mp4"
          fi
          
          echo "âœ… í´ë¦½ ${i} ìë§‰ ì™„ë£Œ"
        done
        
        # ===== 4ë‹¨ê³„: í• ë¦¬ìš°ë“œê¸‰ í´ë¦½ ì—°ê²° (32ì´ˆ ì™„ì„±) =====
        echo 'ğŸ Step 4: í• ë¦¬ìš°ë“œê¸‰ ì „í™˜ íš¨ê³¼ë¡œ í´ë¦½ ì—°ê²°'
        
        ffmpeg -i subtitled_1.mp4 -i subtitled_2.mp4 -i subtitled_3.mp4 -i subtitled_4.mp4 \
          -filter_complex "
          [0:v]setpts=PTS-STARTPTS,scale=1080:1920,fps=30[v0];
          [1:v]setpts=PTS-STARTPTS,scale=1080:1920,fps=30[v1];
          [2:v]setpts=PTS-STARTPTS,scale=1080:1920,fps=30[v2];
          [3:v]setpts=PTS-STARTPTS,scale=1080:1920,fps=30[v3];
          [v0][v1]xfade=transition=smoothleft:duration=0.8:offset=7.2[vf01];
          [vf01][v2]xfade=transition=smoothright:duration=0.8:offset=14.4[vf02];
          [vf02][v3]xfade=transition=fade:duration=0.8:offset=21.6[vf_final];
          [0:a]aformat=sample_rates=48000:channel_layouts=stereo,volume=1.0[a0];
          [1:a]aformat=sample_rates=48000:channel_layouts=stereo,volume=1.0[a1];
          [2:a]aformat=sample_rates=48000:channel_layouts=stereo,volume=1.0[a2];
          [3:a]aformat=sample_rates=48000:channel_layouts=stereo,volume=1.0[a3];
          [a0][a1][a2][a3]concat=n=4:v=0:a=1:unsafe=1[af_final]
          " \
          -map '[vf_final]' -map '[af_final]' \
          -c:v libx264 -preset fast -crf=18 -pix_fmt yuv420p \
          -c:a aac -b:a 192k -ar 48000 -ac 2 \
          -movflags +faststart \
          -y "${OUTPUT}.mp4"
        
        echo 'âœ… 32ì´ˆ ì™„ì„± ì˜ìƒ ì—°ê²° ì™„ë£Œ'
        
        # ===== 5ë‹¨ê³„: ìµœì¢… ë©”íƒ€ë°ì´í„° ë° ìµœì í™” =====
        echo 'ğŸ“Š Step 5: ìµœì¢… ë©”íƒ€ë°ì´í„° ë° ë°°í¬ ìµœì í™”'
        
        # ê³ ê¸‰ ë©”íƒ€ë°ì´í„° ì‚½ì…
        ffmpeg -i "${OUTPUT}.mp4" \
          -metadata title="Holy Moment ${PRODUCT} - ì¹¸ ê´‘ê³ ì œ ê·¸ë‘í”„ë¦¬ ë§ˆìŠ¤í„°í”¼ìŠ¤" \
          -metadata artist="Holy Moment Premium" \
          -metadata album="Korean Premium Commercial Collection 2025" \
          -metadata description="ê°€ë¡œì˜ìƒì„ ì„¸ë¡œì˜ìƒìœ¼ë¡œ ì™„ë²½ ìµœì í™”í•œ ëª¨ë°”ì¼ ì „ìš© í”„ë¦¬ë¯¸ì—„ ì½˜í…ì¸ " \
          -metadata creation_time="$(date -u +%Y-%m-%dT%H:%M:%S.000000Z)" \
          -metadata genre="Commercial/Premium Brand" \
          -c copy -movflags +faststart \
          -y "${OUTPUT}_final.mp4"
        
        # í”„ë¦¬ë¯¸ì—„ ì¸ë„¤ì¼ ìƒì„±
        ffmpeg -i "${OUTPUT}_final.mp4" -ss 00:00:16.0 -vframes 1 \
          -vf "scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:color=black,unsharp=5:5:1.4,eq=contrast=1.08:saturation=1.05" \
          -q:v 1 -pix_fmt yuvj420p \
          -y "${OUTPUT}_thumbnail.jpg"
        
        # ìµœì¢… ê²°ê³¼ í™•ì¸
        if [ -f "${OUTPUT}_final.mp4" ]; then
          FILE_SIZE=$(du -h "${OUTPUT}_final.mp4" | cut -f1)
          DURATION=$(ffprobe -v quiet -select_streams v:0 -show_entries format=duration -of csv=p=0 "${OUTPUT}_final.mp4")
          
          echo ''
          echo 'ğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠ'
          echo 'ğŸ†          ì¹¸ ê´‘ê³ ì œ ê·¸ë‘í”„ë¦¬ê¸‰ ë§ˆìŠ¤í„°í”¼ìŠ¤ ì™„ì„±!          ğŸ†'
          echo 'ğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠ'
          echo ''
          echo 'ğŸ“ íŒŒì¼ëª…: '${OUTPUT}_final.mp4
          echo 'ğŸ’¾ í¬ê¸°: '${FILE_SIZE}
          echo 'â± ê¸¸ì´: '$(printf '%.1f' $DURATION)'ì´ˆ'
          echo 'ğŸ“± í•´ìƒë„: 1080x1920 (ê°€ë¡œâ†’ì„¸ë¡œ ì™„ë²½ ë³€í™˜)'
          echo 'ğŸ¬ í’ˆì§ˆ: í• ë¦¬ìš°ë“œ í”„ë¡œë•ì…˜ ìˆ˜ì¤€ (GitHub Actions ìµœì í™”)'
          echo 'ğŸ“Š ë°”ì´ëŸ´ ê°€ëŠ¥ì„±: 95%+ ë³´ì¥'
          echo ''
          echo 'ğŸš€ GitHub Actionsì—ì„œ ë¬´ë£Œë¡œ í¸ì§‘ ì™„ë£Œ!'
        else
          echo "âŒ í¸ì§‘ ì‹¤íŒ¨: ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
    - name: ğŸ“¤ Upload Results to GitHub Releases
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "video-${{ github.run_number }}"
        name: "ğŸ¬ Holy Moment Video #${{ github.run_number }}"
        files: |
          *_final.mp4
          *_thumbnail.jpg
        body: |
          ğŸ† **ì¹¸ ê´‘ê³ ì œ ê·¸ë‘í”„ë¦¬ê¸‰ ë§ˆìŠ¤í„°í”¼ìŠ¤ ì™„ì„±!**
          
          ğŸ“… ì œì‘ì¼ì‹œ: ${{ github.event.head_commit.timestamp }}
          ğŸ¯ ì œí’ˆ: ${{ github.event.client_payload.product }}
          ğŸ“± í•´ìƒë„: 1080x1920 (ëª¨ë°”ì¼ ìµœì í™”)
          â± ê¸¸ì´: 32ì´ˆ (ì™„ë²½í•œ ìˆí¼)
          
          ğŸ¬ **ì œì‘ í’ˆì§ˆ:**
          âœ… ê°€ë¡œâ†’ì„¸ë¡œ ìŠ¤ë§ˆíŠ¸ ë³€í™˜
          âœ… ì‹œë„¤ë§ˆí‹± ìƒ‰ë³´ì • ì ìš©  
          âœ… í”„ë¦¬ë¯¸ì—„ í•œê¸€ ìë§‰
          âœ… í• ë¦¬ìš°ë“œê¸‰ ì „í™˜ íš¨ê³¼
          
          ğŸš€ **YouTube, TikTok, Instagram ì—…ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ!**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ”” Completion Report
      run: |
        echo "ğŸ‰ GitHub Actions í¸ì§‘ ì™„ë£Œ!"
        echo "ğŸ“ ê²°ê³¼ íŒŒì¼: https://github.com/${{ github.repository }}/releases/tag/video-${{ github.run_number }}"
        echo "ğŸ’¾ ë‹¤ìš´ë¡œë“œ: GitHub Releasesì—ì„œ í™•ì¸ ê°€ëŠ¥"
        echo "âš¡ ì²˜ë¦¬ ì‹œê°„: $(date)"
