name: ğŸ® Holy Moment Video Editor Workflow

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'ì œí’ˆëª…'
        required: true
        type: string
      video_1_url:
        description: 'ì²« ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      video_2_url:
        description: 'ë‘ ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      video_3_url:
        description: 'ì„¸ ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      video_4_url:
        description: 'ë„¤ ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      webhook_url:
        description: 'n8n Webhook URL'
        required: true
        type: string
      make_execution_id:
        description: 'Make ì‹¤í–‰ ID'
        required: false
        type: string
      subtitle_style:
        description: 'ìë¦¼ ìŠ¤íƒ€ì¼'
        required: false
        default: 'premium_modern'
        type: choice
        options:
        - premium_modern
        - elegant_minimal
        - vibrant_impact
        - friendly_casual
      target_audience:
        description: 'íƒ€ê²Ÿ ì—°ë³‘ì¹¼'
        required: false
        default: '20-30ëŒ€'
        type: string
      emotion_flow:
        description: 'ì˜ìƒ ê°ì • íë¦„'
        required: false
        default: 'ê°ë™ì '
        type: string

env:
  PRODUCT_NAME: ${{ github.event.inputs.product_name }}
  DATE_TIME: ${{ github.run_id }}

jobs:
  video-editing:
    name: ğŸ® í• ë¦¬ìš°ë“œê¹ ì˜ìƒ í¸ì§‘
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: ğŸ”§ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ Setup FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3
      with:
        ffmpeg-version: release
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ¨ Install Additional Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y bc curl jq imagemagick
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        fc-cache -fv

    - name: ğŸ“… Download Video Files
      run: |
        mkdir -p ./temp_videos && cd ./temp_videos
        curl -L -o "clip1.mp4" "${{ github.event.inputs.video_1_url }}"
        curl -L -o "clip2.mp4" "${{ github.event.inputs.video_2_url }}"
        curl -L -o "clip3.mp4" "${{ github.event.inputs.video_3_url }}"
        curl -L -o "clip4.mp4" "${{ github.event.inputs.video_4_url }}"
        for i in {1..4}; do
          if [ ! -f "clip${i}.mp4" ]; then exit 1; fi
        done

    - name: ğŸ” Video Analysis & Validation
      run: |
        cd ./temp_videos
        for i in {1..4}; do
          WIDTH=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width -of csv=p=0 "clip${i}.mp4" || echo "1920")
        done

    - name: ğŸ¨ Video Normalization & Enhancement
      run: |
        cd ./temp_videos
        for i in {1..4}; do
          ffmpeg -i "clip${i}.mp4" -vf "scale=1920:1080" -crf 12 -y "normalized_${i}.mp4"
        done

    - name: ğŸ“ Dynamic Subtitle Generation
      run: |
        cd ./temp_videos
        for i in {1..4}; do
          ffmpeg -i "normalized_${i}.mp4" -vf "drawtext=text='Subtitle ${i}'" -y "subtitled_${i}.mp4"
        done

    - name: ğŸ Hollywood-Grade Video Merging
      run: |
        cd ./temp_videos
        ffmpeg -i subtitled_1.mp4 -i subtitled_2.mp4 -i subtitled_3.mp4 -i subtitled_4.mp4 -filter_complex "[0:v][1:v][2:v][3:v]concat=n=4:v=1:a=0[outv]" -map "[outv]" -y merged_final.mp4

    - name: ğŸ’¬ ê²½ì œì  ì´í•´ê´€ê³„ ìë¦¼ ì‚½ì…
      run: |
        cd ./temp_videos
        ffmpeg -i merged_final.mp4 \
        -vf "drawtext=text='ì´ ì˜ìƒì€ ë„¤ì´ë²„ ìƒˆí”Œ ì»¨ë„¤íŠ¸ í™œë™ì˜ ì¼í•œìœ¼ë¡œ ì œì‘ë˜ì—ˆìœ¼ë©°,':fontfile='/usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc':fontsize=42:fontcolor=white:box=1:boxcolor=black@0.6:boxborderw=12:x=(w-text_w)/2:y=(h/2)-50:enable='between(t,1,3.5)',drawtext=text='íŒë§¤ ë°œìƒ ì‹œ ìˆ˜ìˆ˜ë£Œë¥¼ ì œê³µë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.':fontfile='/usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc':fontsize=42:fontcolor=white:box=1:boxcolor=black@0.6:boxborderw=12:x=(w-text_w)/2:y=(h/2)+10:enable='between(t,1,3.5)'" \
        -c:a copy -y merged_final_notice.mp4
        mv merged_final_notice.mp4 merged_final.mp4

    - name: ğŸ“Š Final Processing & Metadata
      run: |
        cd ./temp_videos
        OUTPUT_NAME="HolyMoment_${PRODUCT_NAME}_${DATE_TIME}_MASTERPIECE"
        ffmpeg -i merged_final.mp4 -metadata title="Holy Moment" -c copy -y "${OUTPUT_NAME}.mp4"
        echo "OUTPUT_FILE=${OUTPUT_NAME}.mp4" >> $GITHUB_ENV
        echo "THUMBNAIL_FILE=${OUTPUT_NAME}_thumbnail.jpg" >> $GITHUB_ENV
        echo "REPORT_FILE=${OUTPUT_NAME}_report.txt" >> $GITHUB_ENV

    - name: ğŸ“¤ Notify n8n Completion
      if: success()
      run: |
        cd ./temp_videos
        curl -X POST "${{ github.event.inputs.webhook_url }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"status\": \"completed\",
            \"product_name\": \"${{ env.PRODUCT_NAME }}\",
            \"output_file\": \"${{ env.OUTPUT_FILE }}\",
            \"thumbnail_file\": \"${{ env.THUMBNAIL_FILE }}\",
            \"artifacts_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
            \"download_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts\",
            \"execution_id\": \"${{ github.event.inputs.make_execution_id }}\",
            \"file_size\": \"$(du -h ${{ env.OUTPUT_FILE }} | cut -f1)\",
            \"duration\": \"$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 ${{ env.OUTPUT_FILE }} | awk '{printf \"%.1f\", $1}')\"
          }"

    - name: ğŸ“¤ Notify n8n on Failure  
      if: failure()
      run: |
        curl -X POST "${{ github.event.inputs.webhook_url }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"status\": \"failed\",
            \"error\": \"Video editing failed\",
            \"execution_id\": \"${{ github.event.inputs.make_execution_id }}\",
            \"logs_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
          }"

    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: holy-moment-masterpiece-${{ env.DATE_TIME }}
        path: |
          ./temp_videos/${{ env.OUTPUT_FILE }}
          ./temp_videos/${{ env.THUMBNAIL_FILE }}
          ./temp_videos/${{ env.REPORT_FILE }}
        retention-days: 30

    - name: ğŸ–¼ Create Thumbnail with Emotion Text
      run: |
        cd ./temp_videos
        # ì˜ìƒì—ì„œ ì¸ë„¤ì¼ ì¶”ì¶œ (1.5ì´ˆ ì§€ì )
        ffmpeg -i merged_final.mp4 -ss 00:00:01.500 -vframes 1 thumbnail_raw.jpg

        # ê°ì„± í›„í‚¹ ë¬¸êµ¬ ì„¤ì •
        HOOK_TEXT="${{ github.event.inputs.hook_text }}"

        # í…ìŠ¤íŠ¸ ì…íŒ ê°ì„± ì¸ë„¤ì¼ ìƒì„±
        convert thumbnail_raw.jpg \
          -gravity south \
          -fill white -undercolor '#00000088' \
          -font "Noto-Sans-CJK-Regular" \
          -pointsize 64 \
          -annotate +0+40 "$HOOK_TEXT" \
          "${OUTPUT_NAME}_thumbnail.jpg"

    - name: ğŸŠ Success Summary
      run: |
        echo "ğŸŠ ì„±ê³µ!"

    - name: ğŸªŸ Cleanup
      if: always()
      run: |
        rm -rf ./temp_videos/
