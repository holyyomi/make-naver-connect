name: ğŸ¬ Holy Moment Video Editor Workflow

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'ì œí’ˆëª…'
        required: true
        type: string
      video_1_url:
        description: 'ì²« ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      video_2_url:
        description: 'ë‘ ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      video_3_url:
        description: 'ì„¸ ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      video_4_url:
        description: 'ë„¤ ë²ˆì§¸ ì˜ìƒ URL'
        required: true
        type: string
      subtitle_style:
        description: 'ìë§‰ ìŠ¤íƒ€ì¼'
        required: false
        default: 'premium_modern'
        type: choice
        options:
        - premium_modern
        - elegant_minimal
        - vibrant_impact
        - friendly_casual
      target_audience:
        description: 'íƒ€ê²Ÿ ì—°ë ¹ì¸µ'
        required: false
        default: '20-30ëŒ€'
        type: string
      emotion_flow:
        description: 'ì˜ìƒ ê°ì • íë¦„'
        required: false
        default: 'ê°ë™ì '
        type: string

env:
  PRODUCT_NAME: ${{ github.event.inputs.product_name }}
  DATE_TIME: ${{ github.run_id }}

jobs:
  video-editing:
    name: ğŸ¬ í• ë¦¬ìš°ë“œê¸‰ ì˜ìƒ í¸ì§‘
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ”§ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ Setup FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3
      with:
        ffmpeg-version: release
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ¨ Install Additional Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y bc curl jq imagemagick
        
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        fc-cache -fv
        
        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"

    - name: ğŸ“¥ Download Video Files
      run: |
        echo "ğŸ”½ ì˜ìƒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘"
        
        # ì‘ì—… ë””ë ‰í„°ë¦¬ ìƒì„±
        mkdir -p ./temp_videos
        cd ./temp_videos
        
        # ê° ì˜ìƒ ë‹¤ìš´ë¡œë“œ
        echo "ğŸ“¥ ì˜ìƒ 1 ë‹¤ìš´ë¡œë“œ..."
        curl -L -o "clip1.mp4" "${{ github.event.inputs.video_1_url }}"
        
        echo "ğŸ“¥ ì˜ìƒ 2 ë‹¤ìš´ë¡œë“œ..."
        curl -L -o "clip2.mp4" "${{ github.event.inputs.video_2_url }}"
        
        echo "ğŸ“¥ ì˜ìƒ 3 ë‹¤ìš´ë¡œë“œ..."
        curl -L -o "clip3.mp4" "${{ github.event.inputs.video_3_url }}"
        
        echo "ğŸ“¥ ì˜ìƒ 4 ë‹¤ìš´ë¡œë“œ..."
        curl -L -o "clip4.mp4" "${{ github.event.inputs.video_4_url }}"
        
        # íŒŒì¼ ê²€ì¦
        for i in {1..4}; do
          if [ ! -f "clip${i}.mp4" ]; then
            echo "âŒ í´ë¦½ ${i} ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          SIZE=$(stat -c%s "clip${i}.mp4")
          if [ $SIZE -lt 1000000 ]; then  # 1MB ë¯¸ë§Œì´ë©´ ì˜¤ë¥˜
            echo "âš ï¸ í´ë¦½ ${i} íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤: ${SIZE} bytes"
            exit 1
          fi
          
          echo "âœ… í´ë¦½ ${i} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: $(du -h clip${i}.mp4 | cut -f1)"
        done
        
        echo "ğŸ‰ ëª¨ë“  ì˜ìƒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!"

    - name: ğŸ” Video Analysis & Validation
      run: |
        cd ./temp_videos
        echo "ğŸ” ì˜ìƒ íŒŒì¼ ë¶„ì„ ì‹œì‘"
        
        # ê° ì˜ìƒì˜ ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘
        for i in {1..4}; do
          echo "ğŸ“Š í´ë¦½ ${i} ë¶„ì„ ì¤‘..."
          
          WIDTH=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width -of csv=p=0 "clip${i}.mp4" 2>/dev/null || echo "1920")
          HEIGHT=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=height -of csv=p=0 "clip${i}.mp4" 2>/dev/null || echo "1080")
          DURATION=$(ffprobe -v quiet -select_streams v:0 -show_entries format=duration -of csv=p=0 "clip${i}.mp4" 2>/dev/null || echo "8.0")
          FPS=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=r_frame_rate -of csv=p=0 "clip${i}.mp4" 2>/dev/null | awk -F'/' '{if($2>0) print $1/$2; else print 30}' || echo "30")
          BITRATE=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=bit_rate -of csv=p=0 "clip${i}.mp4" 2>/dev/null || echo "5000000")
          CODEC=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=codec_name -of csv=p=0 "clip${i}.mp4" 2>/dev/null || echo "unknown")
          
          echo "  ğŸ“ í•´ìƒë„: ${WIDTH}x${HEIGHT}"
          echo "  â±ï¸  ê¸¸ì´: ${DURATION}ì´ˆ"
          echo "  ğŸ¬ FPS: ${FPS}"
          echo "  ğŸ“Š ë¹„íŠ¸ë ˆì´íŠ¸: $((${BITRATE}/1000))kbps"
          echo "  ğŸ”§ ì½”ë±: ${CODEC}"
          
          # í’ˆì§ˆ ê²€ì¦
          if (( $(echo "$DURATION < 3" | bc -l) )); then
            echo "âš ï¸ í´ë¦½ ${i} ê¸¸ì´ê°€ ì§§ìŠµë‹ˆë‹¤: ${DURATION}ì´ˆ"
          fi
          
          if [ $WIDTH -lt 720 ] || [ $HEIGHT -lt 720 ]; then
            echo "âš ï¸ í´ë¦½ ${i} í•´ìƒë„ê°€ ë‚®ìŠµë‹ˆë‹¤: ${WIDTH}x${HEIGHT}"
          fi
        done
        
        echo "âœ… ì˜ìƒ ë¶„ì„ ì™„ë£Œ"

    - name: ğŸ¨ Video Normalization & Enhancement
      run: |
        cd ./temp_videos
        echo "ğŸ¨ 4K í’ˆì§ˆ ì •ê·œí™” ë° í™”ì§ˆ í–¥ìƒ ì‹œì‘"
        
        for i in {1..4}; do
          echo "ğŸ”§ í´ë¦½ ${i} ê³ ê¸‰ ì²˜ë¦¬ ì¤‘..."
          
          # ìµœê³ ê¸‰ ë¹„ë””ì˜¤ í•„í„° ì²´ì¸
          VIDEO_FILTERS="scale=1920:1080:force_original_aspect_ratio=increase:eval=frame,crop=1080:1920:(iw-1080)/2:(ih-1920)/2,unsharp=luma_msize_x=7:luma_msize_y=7:luma_amount=1.5:chroma_msize_x=5:chroma_msize_y=5:chroma_amount=1.2,nlmeans=s=2.0:p=7:r=15:pc=1,hqdn3d=4:3:6:4.5,eq=contrast=1.12:brightness=0.05:saturation=1.08:gamma=0.95,colorbalance=rs=0.03:gs=-0.01:bs=-0.04:rm=0.02:gm=0.01:bm=-0.03:rh=-0.01:gh=0.01:bh=0.02,vibrance=intensity=0.15:rbal=1.2:gbal=1.0:bbal=0.9,fps=30"
          
          ffmpeg -i "clip${i}.mp4" \
            -vf "${VIDEO_FILTERS}" \
            -c:v libx264 \
            -preset veryslow \
            -crf 12 \
            -profile:v high \
            -level 5.1 \
            -x264-params 'keyint=60:min-keyint=30:scenecut=40:bframes=3:ref=5:me=umh:subme=10:trellis=2:psy-rd=1.2,0.15:aq-mode=3:aq-strength=0.8' \
            -pix_fmt yuv420p \
            -movflags +faststart+write_colr \
            -color_primaries bt709 \
            -color_trc bt709 \
            -colorspace bt709 \
            -c:a aac -b:a 256k -ar 48000 -ac 2 \
            -af 'dynaudnorm=f=500:g=31:p=0.95:s=0.5,loudnorm=I=-18:TP=-1.5:LRA=8' \
            -t 7.8 \
            -avoid_negative_ts make_zero \
            -y "normalized_${i}.mp4"
          
          echo "âœ… í´ë¦½ ${i} ì •ê·œí™” ì™„ë£Œ"
        done
        
        echo "ğŸ‰ ëª¨ë“  í´ë¦½ ì •ê·œí™” ì™„ë£Œ"

    - name: ğŸ“ Dynamic Subtitle Generation
      run: |
        cd ./temp_videos
        echo "ğŸ“ ë™ì  í”„ë¦¬ë¯¸ì—„ ìë§‰ ìƒì„± ì‹œì‘"
        
        # ì œí’ˆë³„ ë§ì¶¤ ìë§‰
        declare -a SUBTITLE_TEXTS=(
          "ì´ë ‡ê²Œ í˜ë“¤ ì¤„ ëª°ëì–´..."
          "${{ env.PRODUCT_NAME }}ì„(ë¥¼) ë§Œë‚œ ìˆœê°„"
          "ì™„ì „íˆ ë‹¬ë¼ì§„ ë‚´ ì¼ìƒ"
          "ì •ë§ ê°ì‚¬í•œ Holy Moment"
        )
        
        # ìë§‰ ìŠ¤íƒ€ì¼ ì„¤ì •
        SUBTITLE_STYLE="${{ github.event.inputs.subtitle_style }}"
        
        case "$SUBTITLE_STYLE" in
          'premium_modern')
            FONT_SIZE=68; MAIN_COLOR='#FFFFFF'; SHADOW_COLOR='#000000@0.9'
            BOX_COLOR='#1a1a1a@0.82'; BORDER_WIDTH=18; SHADOW_OFFSET='6:6'
            FONT_FILE='/usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc'
            ;;
          'elegant_minimal')
            FONT_SIZE=62; MAIN_COLOR='#F8F8FF'; SHADOW_COLOR='#2F2F2F@0.85'
            BOX_COLOR='#000000@0.75'; BORDER_WIDTH=14; SHADOW_OFFSET='4:4'
            FONT_FILE='/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc'
            ;;
          'vibrant_impact')
            FONT_SIZE=72; MAIN_COLOR='#FFD700'; SHADOW_COLOR='#800000@1.0'
            BOX_COLOR='#000000@0.95'; BORDER_WIDTH=22; SHADOW_OFFSET='8:8'
            FONT_FILE='/usr/share/fonts/opentype/noto/NotoSansCJK-Black.ttc'
            ;;
          *)
            FONT_SIZE=65; MAIN_COLOR='#FFFFFF'; SHADOW_COLOR='#000000@0.88'
            BOX_COLOR='#1C1C1C@0.80'; BORDER_WIDTH=16; SHADOW_OFFSET='5:5'
            FONT_FILE='/usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc'
            ;;
        esac
        
        # í°íŠ¸ íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° ëŒ€ì²´
        if [ ! -f "$FONT_FILE" ]; then
          echo "âš ï¸ ê¸°ë³¸ í°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. ì‹œìŠ¤í…œ í°íŠ¸ ì‚¬ìš©"
          FONT_FILE=$(fc-list | grep -i "noto.*cjk.*bold" | head -1 | cut -d: -f1)
          if [ -z "$FONT_FILE" ]; then
            FONT_FILE="/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc"
          fi
        fi
        
        echo "ğŸ“ ì‚¬ìš©í•  í°íŠ¸: $FONT_FILE"
        
        # ê° í´ë¦½ì— ìë§‰ ì ìš©
        for i in {1..4}; do
          SUB_TEXT="${SUBTITLE_TEXTS[$((i-1))]}"
          echo "ğŸ“ í´ë¦½ ${i}ì— ìë§‰ ì ìš©: ${SUB_TEXT}"
          
          # ìë§‰ í•„í„° ìƒì„±
          SUBTITLE_FILTER="drawtext=text='${SUB_TEXT}':fontfile='${FONT_FILE}':fontsize=${FONT_SIZE}:fontcolor='${MAIN_COLOR}':x=(w-text_w)/2:y=h-th-160:box=1:boxcolor='${BOX_COLOR}':boxborderw=${BORDER_WIDTH}:shadowcolor='${SHADOW_COLOR}':shadowx=${SHADOW_OFFSET%:*}:shadowy=${SHADOW_OFFSET#*:}:enable='between(t,1.5,6.3)'"
          
          ffmpeg -i "normalized_${i}.mp4" \
            -vf "${SUBTITLE_FILTER},fade=in:st=1.5:d=0.8:alpha=1,fade=out:st=5.5:d=0.8:alpha=1" \
            -c:v libx264 -preset veryslow -crf 12 \
            -pix_fmt yuv420p -movflags +faststart \
            -c:a copy \
            -y "subtitled_${i}.mp4"
          
          echo "âœ… í´ë¦½ ${i} ìë§‰ ì™„ë£Œ"
        done
        
        echo "ğŸ‰ ëª¨ë“  ìë§‰ ìƒì„± ì™„ë£Œ"

    - name: ğŸ Hollywood-Grade Video Merging
      run: |
        cd ./temp_videos
        echo "ğŸ í• ë¦¬ìš°ë“œê¸‰ ì˜ìƒ ë³‘í•© ì‹œì‘"
        
        # ì „í™˜ íš¨ê³¼ ì„¤ì •
        TRANSITION_DURATION=0.8
        CLIP_DURATION=7.8
        
        # ì˜¤í”„ì…‹ ê³„ì‚°
        OFFSET_1=$(echo "$CLIP_DURATION - $TRANSITION_DURATION" | bc -l)
        OFFSET_2=$(echo "$OFFSET_1 * 2 + $TRANSITION_DURATION" | bc -l)
        OFFSET_3=$(echo "$OFFSET_1 * 3 + $TRANSITION_DURATION * 2" | bc -l)
        
        echo "ğŸ“Š íƒ€ì´ë° ì„¤ì •:"
        echo "  ì „í™˜ ì‹œê°„: ${TRANSITION_DURATION}ì´ˆ"
        echo "  í´ë¦½ ê¸¸ì´: ${CLIP_DURATION}ì´ˆ"
        echo "  ì˜¤í”„ì…‹ 1: ${OFFSET_1}ì´ˆ"
        echo "  ì˜¤í”„ì…‹ 2: ${OFFSET_2}ì´ˆ"
        echo "  ì˜¤í”„ì…‹ 3: ${OFFSET_3}ì´ˆ"
        
        ffmpeg -i subtitled_1.mp4 -i subtitled_2.mp4 -i subtitled_3.mp4 -i subtitled_4.mp4 \
          -filter_complex "
          [0:v]setpts=PTS-STARTPTS,scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black,fps=30[v0];
          [1:v]setpts=PTS-STARTPTS,scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black,fps=30[v1];
          [2:v]setpts=PTS-STARTPTS,scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black,fps=30[v2];
          [3:v]setpts=PTS-STARTPTS,scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black,fps=30[v3];
          [v0][v1]xfade=transition=smoothleft:duration=${TRANSITION_DURATION}:offset=${OFFSET_1}[vf01];
          [vf01][v2]xfade=transition=smoothright:duration=${TRANSITION_DURATION}:offset=${OFFSET_2}[vf02];
          [vf02][v3]xfade=transition=circleopen:duration=${TRANSITION_DURATION}:offset=${OFFSET_3}[vf_final];
          [0:a]aformat=sample_rates=48000:channel_layouts=stereo,dynaudnorm=f=500:g=31[a0];
          [1:a]aformat=sample_rates=48000:channel_layouts=stereo,dynaudnorm=f=500:g=31[a1];
          [2:a]aformat=sample_rates=48000:channel_layouts=stereo,dynaudnorm=f=500:g=31[a2];
          [3:a]aformat=sample_rates=48000:channel_layouts=stereo,dynaudnorm=f=500:g=31[a3];
          [a0][a1][a2][a3]concat=n=4:v=0:a=1:unsafe=1[af_raw];
          [af_raw]loudnorm=I=-16:TP=-1.0:LRA=7[af_final]
          " \
          -map '[vf_final]' -map '[af_final]' \
          -c:v libx264 -preset veryslow -crf 12 \
          -profile:v high -level 5.1 \
          -pix_fmt yuv420p -movflags +faststart \
          -c:a aac -b:a 256k -ar 48000 -ac 2 \
          -y "merged_final.mp4"
        
        echo "âœ… ì˜ìƒ ë³‘í•© ì™„ë£Œ"

    - name: ğŸ“Š Final Processing & Metadata
      run: |
        cd ./temp_videos
        echo "ğŸ“Š ìµœì¢… ì²˜ë¦¬ ë° ë©”íƒ€ë°ì´í„° ì¶”ê°€"
        
        # ìµœì¢… íŒŒì¼ëª… ì„¤ì •
        OUTPUT_NAME="HolyMoment_${PRODUCT_NAME}_${DATE_TIME}_MASTERPIECE"
        
        # ë©”íƒ€ë°ì´í„° ì‚½ì…
        ffmpeg -i merged_final.mp4 \
          -metadata title="Holy Moment ${PRODUCT_NAME} - í”„ë¦¬ë¯¸ì—„ ë³€í™” ìŠ¤í† ë¦¬" \
          -metadata artist="Holy Moment" \
          -metadata album="Korean Premium Brand Collection 2025" \
          -metadata description="${PRODUCT_NAME}ë¡œ ë³€í™”í•˜ëŠ” ì¼ìƒì˜ ê°ë™ì ì¸ ìˆœê°„ë“¤ì„ ë‹´ì€ í”„ë¦¬ë¯¸ì—„ ì˜ìƒ" \
          -metadata keywords="Holy Moment,${PRODUCT_NAME},Korean Premium,Life Change,Transformation,ê°ë™,ë³€í™”,${{ github.event.inputs.target_audience }},${{ github.event.inputs.emotion_flow }}" \
          -metadata creation_time="$(date -u +%Y-%m-%dT%H:%M:%S.000000Z)" \
          -metadata genre="Commercial/Premium Brand" \
          -metadata producer="Holy Moment Creative" \
          -c copy -movflags +faststart \
          -y "${OUTPUT_NAME}.mp4"
        
        echo "âœ… ë©”íƒ€ë°ì´í„° ì¶”ê°€ ì™„ë£Œ"
        
        # í™©ê¸ˆë¹„ìœ¨ ì¸ë„¤ì¼ ìƒì„±
        echo "ğŸ“¸ í™©ê¸ˆë¹„ìœ¨ ì¸ë„¤ì¼ ìƒì„±"
        GOLDEN_RATIO_TIME=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "${OUTPUT_NAME}.mp4" | awk '{print $1 * 0.618}')
        
        ffmpeg -i "${OUTPUT_NAME}.mp4" -ss ${GOLDEN_RATIO_TIME} -vframes 1 \
          -vf "scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:color=black,unsharp=7:7:1.5:7:7:1.2,eq=contrast=1.08:saturation=1.05" \
          -q:v 1 -pix_fmt yuvj420p \
          -y "${OUTPUT_NAME}_thumbnail.jpg"
        
        echo "âœ… ì¸ë„¤ì¼ ìƒì„± ì™„ë£Œ"
        
        # íŒŒì¼ ì •ë³´ ìˆ˜ì§‘
        FINAL_SIZE=$(du -h "${OUTPUT_NAME}.mp4" | cut -f1)
        FINAL_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "${OUTPUT_NAME}.mp4")
        FINAL_BITRATE=$(ffprobe -v quiet -show_entries format=bit_rate -of csv=p=0 "${OUTPUT_NAME}.mp4")
        
        # í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
        cat > "${OUTPUT_NAME}_report.txt" << EOF
        ğŸ† HOLY MOMENT í• ë¦¬ìš°ë“œê¸‰ ë§ˆìŠ¤í„°í”¼ìŠ¤ ì™„ì„±!
        ================================================
        
        ğŸ“… ì™„ì„± ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')
        ğŸ¯ ì œí’ˆ: ${PRODUCT_NAME}
        ğŸ¬ GitHub Run ID: ${DATE_TIME}
        ğŸ‘¥ íƒ€ê²Ÿ: ${{ github.event.inputs.target_audience }}
        ğŸ’ ê°ì •: ${{ github.event.inputs.emotion_flow }}
        
        ğŸ“ íŒŒì¼ ì •ë³´:
        - íŒŒì¼ëª…: ${OUTPUT_NAME}.mp4
        - í¬ê¸°: ${FINAL_SIZE}
        - ê¸¸ì´: $(printf '%.1f' $FINAL_DURATION)ì´ˆ
        - í•´ìƒë„: 1080x1920 (9:16 ì™„ë²½ ìµœì í™”)
        - ë¹„íŠ¸ë ˆì´íŠ¸: $((${FINAL_BITRATE}/1000))kbps
        - í”„ë ˆì„ìœ¨: 30fps ì‹œë„¤ë§ˆí‹±
        - ì½”ë±: H.264 High Profile + AAC
        
        ğŸ¬ ì ìš©ëœ ê³ ê¸‰ ê¸°ìˆ :
        âœ… AI ê¸°ë°˜ í™”ì§ˆ í–¥ìƒ
        âœ… ì‹œë„¤ë§ˆí‹± ìƒ‰ë³´ì • (ì˜í™”ê¸‰)
        âœ… ë™ì  í”„ë¦¬ë¯¸ì—„ ìë§‰ (${{ github.event.inputs.subtitle_style }})
        âœ… í• ë¦¬ìš°ë“œê¸‰ ì „í™˜ íš¨ê³¼ (3ë‹¨ê³„)
        âœ… í”„ë¡œ ì˜¤ë””ì˜¤ ë§ˆìŠ¤í„°ë§
        âœ… í™©ê¸ˆë¹„ìœ¨ ì¸ë„¤ì¼
        âœ… YouTube Shorts ìµœì í™”
        
        ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!
        EOF
        
        echo "âœ… í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"
        
        # í™˜ê²½ë³€ìˆ˜ì— íŒŒì¼ëª… ì €ì¥
        echo "OUTPUT_FILE=${OUTPUT_NAME}.mp4" >> $GITHUB_ENV
        echo "THUMBNAIL_FILE=${OUTPUT_NAME}_thumbnail.jpg" >> $GITHUB_ENV
        echo "REPORT_FILE=${OUTPUT_NAME}_report.txt" >> $GITHUB_ENV

    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: holy-moment-masterpiece-${{ env.DATE_TIME }}
        path: |
          ./temp_videos/${{ env.OUTPUT_FILE }}
          ./temp_videos/${{ env.THUMBNAIL_FILE }}
          ./temp_videos/${{ env.REPORT_FILE }}
        retention-days: 30

    - name: ğŸŠ Success Summary
      run: |
        cd ./temp_videos
        echo ""
        echo "ğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠ"
        echo "ğŸ†      í• ë¦¬ìš°ë“œê¸‰ ë§ˆìŠ¤í„°í”¼ìŠ¤ ì™„ì„±!      ğŸ†"
        echo "ğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠ"
        echo ""
        echo "ğŸ“ ë©”ì¸ íŒŒì¼: ${{ env.OUTPUT_FILE }}"
        echo "ğŸ’¾ ìš©ëŸ‰: $(du -h ${{ env.OUTPUT_FILE }} | cut -f1)"
        echo "â±ï¸ ê¸¸ì´: $(ffprobe -v quiet -show_entries format=duration -of csv=p=0 ${{ env.OUTPUT_FILE }} | awk '{printf "%.1f", $1}')ì´ˆ"
        echo "ğŸ“± í•´ìƒë„: 1080x1920 (ëª¨ë°”ì¼ ì™„ë²½ ìµœì í™”)"
        echo "ğŸ¬ í’ˆì§ˆ: í• ë¦¬ìš°ë“œ í”„ë¡œë•ì…˜ê¸‰"
        echo "ğŸ“¸ ì¸ë„¤ì¼: ${{ env.THUMBNAIL_FILE }}"
        echo "ğŸ“Š ë¦¬í¬íŠ¸: ${{ env.REPORT_FILE }}"
        echo ""
        echo "ğŸš€ GitHub Artifactsì— ì—…ë¡œë“œ ì™„ë£Œ!"
        echo "ğŸ’° YouTube Shorts ë°”ì´ëŸ´ ìµœì í™” ì™„ë£Œ!"
        echo "ğŸ† Holy Moment ë¸Œëœë”© ì™„ì„±!"
        echo ""
        echo "ğŸ”— ë‹¤ìš´ë¡œë“œ: GitHub Actions â†’ Artifacts íƒ­"

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
        rm -rf ./temp_videos/clip*.mp4
        rm -rf ./temp_videos/normalized_*.mp4
        rm -rf ./temp_videos/subtitled_*.mp4
        rm -rf ./temp_videos/merged_final.mp4
        echo "âœ… ì •ë¦¬ ì™„ë£Œ"

  notify-completion:
    name: ğŸ“¢ ì™„ë£Œ ì•Œë¦¼
    needs: video-editing
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: needs.video-editing.result == 'success'
      run: |
        echo "ğŸ‰ Holy Moment ì˜ìƒ í¸ì§‘ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“¥ GitHub Actions > Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”."
        
    - name: âŒ Failure Notification  
      if: needs.video-editing.result == 'failure'
      run: |
        echo "âŒ ì˜ìƒ í¸ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."

- name: ğŸ“¤ Notify Make.com Completion
  if: success()
  run: |
    cd ./temp_videos
    
    # Make.comìœ¼ë¡œ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡
    curl -X POST "${{ github.event.client_payload.webhook_url }}" \
      -H "Content-Type: application/json" \
      -d "{
        \"status\": \"completed\",
        \"product_name\": \"${{ env.PRODUCT_NAME }}\",
        \"output_file\": \"${{ env.OUTPUT_FILE }}\",
        \"thumbnail_file\": \"${{ env.THUMBNAIL_FILE }}\",
        \"artifacts_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
        \"download_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts\",
        \"execution_id\": \"${{ github.event.client_payload.make_execution_id }}\",
        \"file_size\": \"$(du -h ${{ env.OUTPUT_FILE }} | cut -f1)\",
        \"duration\": \"$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 ${{ env.OUTPUT_FILE }} | awk '{printf \"%.1f\", $1}')\"
      }"

- name: ğŸ“¤ Notify Make.com on Failure  
  if: failure()
  run: |
    curl -X POST "${{ github.event.client_payload.webhook_url }}" \
      -H "Content-Type: application/json" \
      -d "{
        \"status\": \"failed\",
        \"error\": \"Video editing failed\",
        \"execution_id\": \"${{ github.event.client_payload.make_execution_id }}\",
        \"logs_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
      }"
